library(ALA4R)
library(raster)
library(data.table)
download_occurrences = function (taxon, wkt, fields, qa, method = "offline",
email, download_reason_id, verbose = TRUE) {
'Summary'
'-------'
'Simplified and customised ALA occurrence download function'
''
'Args'
'----'
'taxon: any taxonomic search construct'
'wkt: well known text polygon to limit records retrieved'
'fields: CSV of data fields to return. If missing, default used'
'qa: CSV of quality assertion fields to return. If missing default used'
'method: indexed or offline.'
'email: user email'
'download_reason_id: acceptable id (0:12) see ala website'
'verbose: default TRUE'
''
'Returns'
'-------'
'Query status printed to screen'
''
'Depends'
'-------'
'Depends on pkgs: assertthat, httr'
'Depends on func: build_url_from_parts (ALA4R)'
''
'Examples'
'--------'
'...'
''
'Notes'
'-----'
'Largely a hack of the ALA4R function'
'Strips out many of the capabilities of the original function'
'TODO: add indexed download (currently offline only)'
'end doc string'
pkg_check = suppressWarnings(lapply(c('httr', 'assertthat'), require, character.only = TRUE))
if(!all(unlist(pkg_check))) stop('Could not load one of required packages httr or asserthat')
## possibly leave this in case smaller downloads are required
method <- match.arg(tolower(method), c("offline", "indexed"))
if (method == "indexed") {
valid_fields_type <- "occurrence_stored"
stop('indexed currently not available: use ALA4R package instead')
} else {
valid_fields_type <- "occurrence"
}
## query container
this_query <- list()
## must be included
if (!missing(taxon)) {
if (is.factor(taxon)) {
taxon <- as.character(taxon)
}
assert_that(is.notempty.string(taxon))
this_query$q <- taxon
}
# optional
if (!missing(wkt)) {
assert_that(is.notempty.string(wkt))
this_query$wkt <- wkt
}
## ammend if I leave out the above
if (length(this_query) == 0) {
stop("invalid request: need at least one of taxon, fq, or wkt to be specified")
}
## leave for now
if (method == "offline") {
#if (record_count_only)
#    stop("record_count_only can only be used with method=\"indexed\"")
if (missing(email) || !is.string(email) || nchar(email) < 1)
stop("email is required for method=offline")
}
## here I think I can just assume that a numeric reason is always entered.
## could even hard-code one.
reason_ok <- !is.na(download_reason_id)
if (reason_ok) {
## Should take a code from 0-12
reason_ok = reason_ok %in% seq(0:12)
}
## modify later
if (!reason_ok) {
stop("download_reason_id must be a valid reason_id. See...")
}
## This guy. I think for our purposes we just need a standard set of
## field names. These could be called from a file, or loaded in the
## function. Assume for now it is loaded into memory and called by
## fields arg.
if (!missing(fields)) {
assert_that(is.character(fields))
this_query$fields <- paste(fields, collapse = ",")
} else {
if(verbose) cat('... Requesting default fields', sep = '\n')
fields = as.character(c('occurrenceID',
'kingdom.p',
'phylum.p',
'classs.p',
'order.p',
'family.p',
'genus.p',
'subgenus.p',
'specificEpithet',
'scientificName.p',
'acceptedNameUsage',
'taxonConceptID.p',
'taxonRank.p',
'eventDate.p',
'year.p',
'decimalLatitude.p',
'decimalLongitude.p',
'coordinateUncertaintyInMeters.p'))
this_query$fields <- paste(fields, collapse = ",")
}
## Think this should error if missing. As above it will probably be a file
## that needs to be in memory (or set to a hard-coded path).
if (!missing(qa)){
assert_that(is.character(qa))
this_query$qa <- paste(qa, collapse = ",")
} else {
if(verbose) cat('... Requesting default quality assertion fields', sep = '\n')
qa = as.character(c('zeroCoordinates',
#'nameNotSupplied',
'nameNotRecognised',
'decimalLatLongCalculationFromEastingNorthingFailed',
'zeroLatitude',
#'decimalLatLongCalculationFromVerbatimFailed',
'coordinatesCentreOfCountry',
'processingError',
'occCultivatedEscapee',
'coordinatesCentreOfStateProvince',
'decimalLatLongConversionFailed',
'zeroLongitude'))
qa = 'includeall'
this_query$qa <- paste(qa, collapse = ",")
}
if (method == "offline") this_query$email <- email
this_query$reasonTypeId <- download_reason_id
#this_query$sourceTypeId <- ala_sourcetypeid()
this_query$esc <- "\\"
## This guy!
#this_query$sep <- "\t"
this_query$sep <- ","
## Make the file name something intuitive
#this_query$file <- "data"
## Build file name from taxon search and date
fn = gsub("[[:punct:]]", "_", taxon)
fn = paste(fn, Sys.Date(), sep = '_')
fn = gsub(' ', '_', fn)
this_query$file <- fn
## I think this is all good.
## If I want to simply, remove 'indexed' option
if (method == "indexed"){
this_url <- build_url_from_parts(getOption("ALA4R_server_config")$base_url_biocache,
c("occurrences", "index", "download"), query = this_query)
} else {
this_url <- build_url_from_parts(getOption("ALA4R_server_config")$base_url_biocache,
c("occurrences", "offline", "download"), query = this_query)
}
## Think a lot of this can be junked.
## Build in a pinger to the ALA server.
if (method == "offline") {
## send request
result = GET(this_url)
if(verbose){
if(status_code(result) == 200) {
requestStatus = paste('Request status: ', content(result)$status, sep = '')
queueSize = paste('Queue size: ', content(result)$queueSize, sep = '')
msg = 'ALA query is being processed'
cat(msg, requestStatus, queueSize, sep = '\n')
} else {
print(paste('Something has gone wrong with the request ',
'(status ', status_code(result), ')', sep = ''))
}
}
}
}
download_occurrences(taxon="genus:Wandella", wkt="POLYGON((112.0+44.0,154.0+44.0,154.0+9.0,112.0+9.0,112.0+44.0))", fields, qa, method = "offline",
email="karel.mokany@csiro.au", download_reason_id="7", verbose = TRUE)
library(assertthat)
library(httr)
download_occurrences(taxon="genus:Wandella", wkt="POLYGON((112.0+44.0,154.0+44.0,154.0+9.0,112.0+9.0,112.0+44.0))", fields, qa, method = "offline",
email="karel.mokany@csiro.au", download_reason_id="7", verbose = TRUE)
